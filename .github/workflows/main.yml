name: Flappy Faso CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.9'
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  test:
    name: Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Configuration de Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
      
    - name: Installation des dÃ©pendances systÃ¨me
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-venv \
          git \
          wget \
          unzip
          
    - name: Installation des dÃ©pendances Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov kivy
      
    - name: Validation de la syntaxe
      run: |
        python -m py_compile main.py
        python -c "import kivy; print('Kivy version:', kivy.__version__)
      
    - name: Tests unitaires
      run: |
        python -m pytest tests/ -v --cov=.
      
    - name: VÃ©rification des ressources
      run: |
        echo "VÃ©rification des fichiers requis..."
        
        # VÃ©rification des rÃ©pertoires
        if [ ! -d "assets/sounds" ]; then
          mkdir -p assets/sounds
          echo "âš ï¸  RÃ©pertoire sounds crÃ©Ã© - ajoutez les fichiers audio")
        fi
        
        # VÃ©rification des fichiers critiques
        required_files=("main.py" "requirements.txt")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Fichier manquant: $file"
            exit 1
        fi
        
        echo "âœ… Tous les fichiers requis sont prÃ©sents"
      
    - name: Rapport de couverture
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        
    - name: Build documentation
      run: |
        echo "ðŸ“š GÃ©nÃ©ration de la documentation..."
        # Ici vous pourriez gÃ©nÃ©rer de la documentation automatique
        echo "Documentation gÃ©nÃ©rÃ©e avec succÃ¨s"
      
    - name: Archive des artefacts de test
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          coverage.xml
          htmlcov/
          
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Configuration de Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
      
    - name: Installation de Buildozer et dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython virtualenv
        pip install -r requirements.txt
        
    - name: Configuration de l'environnement Android
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          wget \
          unzip \
          libncurses5 \
          openjdk-8-jdk \
          zlib1g-dev
          
    - name: Build de l'APK avec Buildozer
      run: |
        echo "ðŸ—ï¸  Construction de l'APK Android..."
        
        # Configuration de Buildozer
        buildozer init
        
        # Construction debug
        buildozer -v android debug
        
    - name: Upload APK en tant qu'artefact
      uses: actions/upload-artifact@v4
      with:
        name: flappy-faso-android
        path: bin/*.apk
        
    - name: CrÃ©ation du nom de version
      run: |
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        echo "BUILD_NAME=flappy_faso_v${BUILD_VERSION}_${TIMESTAMP}" >> $GITHUB_ENV
        
    - name: Renommage de l'APK
      run: |
        mv bin/*.apk bin/flappy_faso_v${BUILD_VERSION}.apk"
        
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: test
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Configuration de Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
      
    - name: Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable Windows
      run: |
        echo "ðŸ—ï¸  Construction de l'exÃ©cutable Windows..."
        pyinstaller --onefile --windowed main.py
        
    - name: Upload executable Windows
      uses: actions/upload-artifact@v4
      with:
        name: flappy-faso-windows
        path: dist/main.exe
        
  deploy:
    name: DÃ©ploiement Release
    runs-on: ubuntu-latest
    needs: [test, build-android]
    
    # Seulement pour les tags ou push sur main
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: TÃ©lÃ©chargement des artefacts de build
      uses: actions/download-artifact@v4
      with:
        name: flappy-faso-android
        path: ./artefacts
        
    - name: CrÃ©ation de la release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artefacts/*.apk
          ./README.md
          ./requirements.txt
          
    - name: Publication sur Google Play (optionnel)
      if: startsWith(github.ref, 'refs/tags/'))
      run: |
        echo "ðŸ“± Publication sur Google Play..."
        # Ici vous intÃ©greriez l'API Google Play
        echo "Release crÃ©Ã©e avec succÃ¨s"
        
  security-scan:
    name: Analyse de SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Scan de sÃ©curitÃ© avec Bandit
      run: |
        pip install bandit
        bandit -r . -f html -o security-report.html
        
    - name: Upload rapport de sÃ©curitÃ©
      uses: actions/upload-artifact@v4
      with:
        name: security-scan
        path: security-report.html
        
    - name: Scan des dÃ©pendances
      run: |
        pip install safety
        safety check --json --output safety-report.json
        
    - name: Analyse des dÃ©pendances
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          security-report.html
          safety-report.json
          
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [test, build-android, security-scan]
    if: always()
    
    steps:
    - name: Notification Slack (optionnel)
      if: always()
      run: |
        echo "ðŸ“¢ Notification du statut de build..."
        # IntÃ©gration Slack/Discord/Email
        echo "Build ${{ github.workflow }} terminÃ© avec statut: ${{ needs.test.result }}"
        
  auto-version:
    name: Auto Versioning
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: GÃ©nÃ©ration du numÃ©ro de version
      run: |
        VERSION=$(date +'%Y.%m.%d')
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
      
    - name: Mise Ã  jour de la version
      run: |
        # Mise Ã  jour du buildozer.spec
        sed -i "s/version = .*/version = ${VERSION}/" buildozer.spec
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add buildozer.spec
        git commit -m "Auto version: ${VERSION}" || exit 0
